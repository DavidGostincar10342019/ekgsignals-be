<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 Test Accordion Results UI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Include styles from tmp_rovodev_accordion_styles.css */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f6fa;
        }
        
        /* ===== MAIN CONTAINER ===== */
        .accordion-results {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== STATUS BANNER ===== */
        .status-banner {
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .status-banner.status-normal {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .status-banner.status-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .status-banner.status-critical {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .status-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-content i {
            font-size: 2.5rem;
            opacity: 0.9;
        }

        .status-text h3 {
            margin: 0 0 4px 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .status-text p {
            margin: 0;
            opacity: 0.9;
            font-size: 1rem;
        }

        /* ===== ACCORDION CONTAINER ===== */
        .accordion-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        /* ===== ACCORDION SECTIONS ===== */
        .accordion-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }

        .accordion-section:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border-color: #667eea;
        }

        .accordion-section.expanded {
            border-color: #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.15);
        }

        /* ===== ACCORDION HEADER ===== */
        .accordion-header {
            padding: 18px 24px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            border-bottom: 1px solid transparent;
        }

        .accordion-header:hover {
            background: #e9ecef;
        }

        .accordion-section.expanded .accordion-header {
            background: #667eea;
            color: white;
            border-bottom-color: rgba(255,255,255,0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-content i {
            font-size: 1.2rem;
            width: 20px;
            text-align: center;
        }

        .header-content h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 1rem;
            opacity: 0.7;
        }

        .toggle-icon.rotated {
            transform: rotate(180deg);
        }

        .accordion-section.expanded .toggle-icon {
            opacity: 1;
        }

        /* ===== ACCORDION CONTENT ===== */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .accordion-content.show {
            max-height: 2000px;
        }

        .content-inner {
            padding: 24px;
            border-top: 1px solid #e9ecef;
        }

        /* ===== SUMMARY GRID ===== */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            text-align: center;
        }

        .summary-card h5 {
            margin: 0 0 12px 0;
            color: #495057;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }

        .summary-card .range {
            font-size: 0.85rem;
            color: #6c757d;
        }

        /* ===== DATA TABLE ===== */
        .data-table {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #e9ecef;
        }

        .data-row .label {
            font-weight: 600;
            color: #495057;
            flex: 1;
        }

        .data-row .value {
            font-weight: 500;
            color: #212529;
            text-align: right;
        }

        .data-row .value.highlight {
            color: #667eea;
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* ===== ARRHYTHMIA STYLES ===== */
        .no-arrhythmia {
            text-align: center;
            padding: 40px 20px;
            background: #d4edda;
            border-radius: 10px;
            color: #155724;
        }

        .no-arrhythmia i {
            font-size: 3rem;
            margin-bottom: 16px;
            color: #28a745;
        }

        .arrhythmia-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .arrhythmia-item {
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            background: #fff3cd;
        }

        .arrhythmia-item.critical {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .arrhythmia-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            color: #856404;
        }

        .arrhythmia-item.critical .arrhythmia-header {
            color: #721c24;
        }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            text-decoration: none;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-viz {
            width: 100%;
            padding: 10px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .results-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            padding: 24px 0;
            border-top: 2px solid #e9ecef;
        }

        /* ===== VISUALIZATIONS ===== */
        .visualization-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .viz-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        .viz-card h5 {
            margin: 0 0 12px 0;
            color: #495057;
            font-size: 1rem;
            font-weight: 600;
        }

        .viz-card p {
            margin: 0 0 16px 0;
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* ===== TEST GRID FOR CORRELATION & IMAGE PROCESSING ===== */
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .test-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        .test-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .test-card h5 {
            margin: 0 0 12px 0;
            color: #495057;
            font-size: 1rem;
            font-weight: 600;
        }

        .test-card p {
            margin: 0 0 16px 0;
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* ===== CORRELATION & PROCESSING RESULTS ===== */
        .correlation-results,
        .processing-results {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .processing-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            color: #856404;
        }

        .success-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            color: #155724;
        }

        .processing-message i.fa-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ===== SECTION DESCRIPTIONS ===== */
        .section-description {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            color: #0d47a1;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .correlation-section .test-card {
            border-left: 4px solid #17a2b8;
        }

        .image-processing-section .test-card {
            border-left: 4px solid #6f42c1;
        }

        @media (max-width: 768px) {
            .status-content {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .data-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .visualization-grid,
            .test-grid {
                grid-template-columns: 1fr;
            }
            
            .test-card {
                padding: 16px;
            }
        }
        
        /* DEMO SPECIFIC STYLES */
        .demo-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .demo-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .demo-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .demo-btn:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="demo-header">
        <h1>🧪 Test Accordion Results Interface</h1>
        <p>Preview novog UI-ja pre implementacije u glavnu aplikaciju</p>
        
        <div class="demo-controls">
            <button class="demo-btn" onclick="loadTestData('normal')">
                <i class="fas fa-heart"></i> Normal EKG
            </button>
            <button class="demo-btn" onclick="loadTestData('arrhythmia')">
                <i class="fas fa-exclamation-triangle"></i> Sa aritmijama
            </button>
            <button class="demo-btn" onclick="loadTestData('tachycardia')">
                <i class="fas fa-tachometer-alt"></i> Tahikardija
            </button>
            <button class="demo-btn" onclick="expandAll()">
                <i class="fas fa-expand"></i> Proširi sve
            </button>
            <button class="demo-btn" onclick="collapseAll()">
                <i class="fas fa-compress"></i> Skupi sve
            </button>
        </div>
    </div>

    <!-- Results Container -->
    <div id="testResults"></div>

    <script>
        // 🎯 ACCORDION-STYLE RESULTS DISPLAY
        // Svaka sekcija se prikazuje kada korisnik klikne

        class AccordionResultsDisplay {
            constructor() {
                this.expandedSections = new Set(['summary']); // Summary otvoren po defaultu
            }

            // 🎯 GLAVNA FUNKCIJA - zamenjuje postojeću populateStructuredResults
            generateAccordionInterface(data) {
                return `
                    <div class="accordion-results">
                        <!-- Quick Status Banner -->
                        ${this.generateStatusBanner(data)}
                        
                        <!-- Accordion Sections -->
                        <div class="accordion-container">
                            ${this.generateAccordionSection('summary', 'Pregled rezultata', 'fas fa-tachometer-alt', this.generateSummaryContent(data), true)}
                            ${this.generateAccordionSection('signal-info', 'Opšti Podaci o Signalu', 'fas fa-info-circle', this.generateSignalInfoContent(data))}
                            ${this.generateAccordionSection('heart-rate', 'Srčani Ritam', 'fas fa-heartbeat', this.generateHeartRateContent(data))}
                            ${this.generateAccordionSection('r-peaks', 'Analiza R-pikova', 'fas fa-chart-line', this.generateRPeaksContent(data))}
                            ${this.generateAccordionSection('hrv', 'Varijabilnost Srčanog Ritma (HRV)', 'fas fa-activity', this.generateHRVContent(data))}
                            ${this.generateAccordionSection('arrhythmia', 'Detekcija Aritmija', 'fas fa-exclamation-triangle', this.generateArrhythmiaContent(data))}
                            ${this.generateAccordionSection('fft', 'FFT Frekvencijska Analiza', 'fas fa-wave-square', this.generateFFTContent(data))}
                            ${this.generateAccordionSection('quality', 'Kvalitet Signala', 'fas fa-signal', this.generateQualityContent(data))}
                            ${this.generateAccordionSection('visualizations', 'Vizuelizacije za master rad', 'fas fa-chart-bar', this.generateVisualizationsContent(data))}
                            ${this.generateAccordionSection('correlation', 'Test Korelacije', 'fas fa-chart-area', this.generateCorrelationContent(data))}
                            ${this.generateAccordionSection('image-processing', 'Image Processing', 'fas fa-image', this.generateImageProcessingContent(data))}
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="results-actions">
                            <button class="btn btn-primary" onclick="window.ekgAnalyzer.generatePDF()">
                                <i class="fas fa-download"></i> Preuzmi PDF izveštaj
                            </button>
                            <button class="btn btn-secondary" onclick="window.accordionDisplay.expandAllSections()">
                                <i class="fas fa-expand-arrows-alt"></i> Proširi sve sekcije
                            </button>
                        </div>
                    </div>
                `;
            }

            // 🎯 STATUS BANNER - Quick overview
            generateStatusBanner(data) {
                const heartRate = data.arrhythmia_detection?.heart_rate;
                const avgBpm = heartRate?.average_bpm || 0;
                const arrhythmias = data.arrhythmia_detection?.arrhythmias?.detected || [];
                
                let status = "Normal EKG";
                let statusClass = "status-normal";
                let statusIcon = "fas fa-check-circle";
                
                if (avgBpm > 150 || avgBpm < 50) {
                    status = "Abnormalna frekvencija";
                    statusClass = "status-critical";
                    statusIcon = "fas fa-times-circle";
                } else if (arrhythmias.length > 0) {
                    status = "Detektovane aritmije";
                    statusClass = "status-warning";
                    statusIcon = "fas fa-exclamation-triangle";
                }

                return `
                    <div class="status-banner ${statusClass}">
                        <div class="status-content">
                            <i class="${statusIcon}"></i>
                            <div class="status-text">
                                <h3>${status}</h3>
                                <p>Srčana frekvencija: ${Math.round(avgBpm)} bpm | ${arrhythmias.length} aritmija${arrhythmias.length === 1 ? '' : 'a'} detektovano</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 🎯 ACCORDION SECTION GENERATOR
            generateAccordionSection(sectionId, title, icon, content, expanded = false) {
                const isExpanded = expanded || this.expandedSections.has(sectionId);
                return `
                    <div class="accordion-section ${isExpanded ? 'expanded' : ''}" data-section="${sectionId}">
                        <div class="accordion-header" onclick="window.accordionDisplay.toggleSection('${sectionId}')">
                            <div class="header-content">
                                <i class="${icon}"></i>
                                <h4>${title}</h4>
                            </div>
                            <i class="fas fa-chevron-down toggle-icon ${isExpanded ? 'rotated' : ''}"></i>
                        </div>
                        <div class="accordion-content ${isExpanded ? 'show' : ''}">
                            <div class="content-inner">
                                ${content}
                            </div>
                        </div>
                    </div>
                `;
            }

            // 📊 SUMMARY CONTENT
            generateSummaryContent(data) {
                const heartRate = data.arrhythmia_detection?.heart_rate;
                const avgBpm = Math.round(heartRate?.average_bpm || 0);
                const arrhythmias = data.arrhythmia_detection?.arrhythmias?.detected || [];
                const signalInfo = data.signal_info || {};

                return `
                    <div class="summary-grid">
                        <div class="summary-card">
                            <h5><i class="fas fa-heartbeat"></i> Srčana frekvencija</h5>
                            <div class="value">${avgBpm} bpm</div>
                            <div class="range">Opseg: ${Math.round(heartRate?.min_bpm || 0)}-${Math.round(heartRate?.max_bpm || 0)} bpm</div>
                        </div>
                        <div class="summary-card">
                            <h5><i class="fas fa-clock"></i> Trajanje analize</h5>
                            <div class="value">${signalInfo.duration || 'N/A'}s</div>
                            <div class="range">${signalInfo.total_samples || 'N/A'} uzoraka</div>
                        </div>
                        <div class="summary-card">
                            <h5><i class="fas fa-exclamation-triangle"></i> Aritmije</h5>
                            <div class="value">${arrhythmias.length}</div>
                            <div class="range">${arrhythmias.length > 0 ? 'Detektovane' : 'Nisu detektovane'}</div>
                        </div>
                    </div>
                `;
            }

            // 📈 SIGNAL INFO CONTENT
            generateSignalInfoContent(data) {
                const signalInfo = data.signal_info || {};
                return `
                    <div class="data-table">
                        <div class="data-row">
                            <span class="label">Broj analiziranih uzoraka:</span>
                            <span class="value">${(signalInfo.total_samples || 0).toLocaleString()}</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Trajanje analize:</span>
                            <span class="value">${signalInfo.duration || 'N/A'}s</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Frekvencija uzorkovanja:</span>
                            <span class="value">${signalInfo.sampling_rate || 250} Hz</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Tip signala:</span>
                            <span class="value">${signalInfo.source === 'wfdb_import' ? 'MIT-BIH Database' : signalInfo.source === 'raw_import' ? 'Sirovi signal' : 'Analiza slike'}</span>
                        </div>
                    </div>
                `;
            }

            // ❤️ HEART RATE CONTENT
            generateHeartRateContent(data) {
                const heartRate = data.arrhythmia_detection?.heart_rate || {};
                return `
                    <div class="data-table">
                        <div class="data-row">
                            <span class="label">Prosečna frekvencija:</span>
                            <span class="value highlight">${(heartRate.average_bpm || 0).toFixed(1)} bpm</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Minimalna frekvencija:</span>
                            <span class="value">${(heartRate.min_bpm || 0).toFixed(1)} bpm</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Maksimalna frekvencija:</span>
                            <span class="value">${(heartRate.max_bpm || 0).toFixed(1)} bpm</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Standardna devijacija:</span>
                            <span class="value">${(heartRate.heart_rate_variability || 0).toFixed(1)} ms</span>
                        </div>
                    </div>
                `;
            }

            // 📊 R-PEAKS CONTENT
            generateRPeaksContent(data) {
                const rPeaks = data.r_peak_detection || {};
                const arrhythmia = data.arrhythmia_detection || {};
                
                return `
                    <div class="data-table">
                        <div class="data-row">
                            <span class="label">Broj R-pikova:</span>
                            <span class="value highlight">${rPeaks.r_peaks_count || arrhythmia.heart_rate?.r_peaks_count || 'N/A'}</span>
                        </div>
                        <div class="data-row">
                            <span class="label">RR intervali:</span>
                            <span class="value">${(rPeaks.r_peaks_count || arrhythmia.heart_rate?.r_peaks_count || 1) - 1}</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Metod detekcije:</span>
                            <span class="value">signal_analysis_with_morphology</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Prosečni RR interval:</span>
                            <span class="value">${arrhythmia.heart_rate?.average_rr_interval ? (arrhythmia.heart_rate.average_rr_interval * 1000).toFixed(1) + ' ms' : 'N/A'}</span>
                        </div>
                    </div>
                `;
            }

            // 📈 HRV CONTENT
            generateHRVContent(data) {
                const heartRate = data.arrhythmia_detection?.heart_rate || {};
                const hrv = heartRate.heart_rate_variability || 0;
                
                let interpretation = "Normalna varijabilnost";
                if (hrv > 100) interpretation = "Visoka varijabilnost (dobra autonomna regulacija)";
                else if (hrv < 20) interpretation = "Niska varijabilnost (moguć stres ili aritmija)";
                
                return `
                    <div class="data-table">
                        <div class="data-row">
                            <span class="label">HRV (standardna devijacija):</span>
                            <span class="value highlight">${hrv.toFixed(1)} ms</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Interpretacija:</span>
                            <span class="value">${interpretation}</span>
                        </div>
                        <div class="data-row">
                            <span class="label">RMSSD:</span>
                            <span class="value">${heartRate.rmssd ? heartRate.rmssd.toFixed(1) + ' ms' : 'N/A'}</span>
                        </div>
                        <div class="data-row">
                            <span class="label">NN50 count:</span>
                            <span class="value">${heartRate.nn50_count || 'N/A'}</span>
                        </div>
                    </div>
                `;
            }

            // ⚠️ ARRHYTHMIA CONTENT
            generateArrhythmiaContent(data) {
                const arrhythmias = data.arrhythmia_detection?.arrhythmias?.detected || [];
                
                if (arrhythmias.length === 0) {
                    return `
                        <div class="no-arrhythmia">
                            <i class="fas fa-check-circle"></i>
                            <h5>Nisu detektovane aritmije</h5>
                            <p>Analiza RR intervala iz detektovanih R-pikova pokazuje regularni sinusni ritam.</p>
                        </div>
                    `;
                }

                return `
                    <div class="arrhythmia-section">
                        <div class="data-row">
                            <span class="label">Osnova za analizu:</span>
                            <span class="value">RR intervali iz detektovanih R-pikova</span>
                        </div>
                        <div class="arrhythmia-list">
                            ${arrhythmias.map(arr => `
                                <div class="arrhythmia-item ${arr.severity || 'warning'}">
                                    <div class="arrhythmia-header">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>${arr.type}</strong>
                                    </div>
                                    <div class="arrhythmia-description">${arr.description || arr.details || 'Detektovano u analizi'}</div>
                                    ${arr.value ? `<div class="arrhythmia-value">Vrednost: ${arr.value}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // 📊 FFT CONTENT
            generateFFTContent(data) {
                const fft = data.fft_analysis || {};
                const dominantFreq = fft.dominant_frequency || 0;
                const bpmFromFreq = dominantFreq * 60;
                
                let interpretation = "Normalna frekvencija (60-100 bpm)";
                if (bpmFromFreq > 100) interpretation = "Povišena frekvencija (120-180 bpm)";
                else if (bpmFromFreq < 60) interpretation = "Snižena frekvencija (40-60 bpm)";
                
                return `
                    <div class="data-table">
                        <div class="data-row">
                            <span class="label">Dominantna frekvencija:</span>
                            <span class="value highlight">${dominantFreq.toFixed(2)} Hz</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Peak amplituda:</span>
                            <span class="value">${(fft.peak_amplitude || 0).toFixed(4)}</span>
                        </div>
                        <div class="data-row">
                            <span class="label">DC komponenta uklonjena:</span>
                            <span class="value">✅ Da (${(fft.dc_component || 0).toFixed(4)})</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Analizirani opseg:</span>
                            <span class="value">0.5-50.0 Hz (fiziološki opseg za EKG)</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Interpretacija:</span>
                            <span class="value">${interpretation}</span>
                        </div>
                    </div>
                `;
            }

            // 📶 QUALITY CONTENT
            generateQualityContent(data) {
                const quality = data.arrhythmia_detection?.signal_quality || {};
                return `
                    <div class="data-table">
                        <div class="data-row">
                            <span class="label">Ocena kvaliteta:</span>
                            <span class="value highlight">${quality.quality || 'Odličan'}</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Signal-to-Noise Ratio:</span>
                            <span class="value">${quality.snr_db ? quality.snr_db.toFixed(1) + ' dB' : 'N/A'}</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Baseline drift:</span>
                            <span class="value">${quality.baseline_drift || 'Minimalan'}</span>
                        </div>
                        <div class="data-row">
                            <span class="label">Artefakti:</span>
                            <span class="value">${quality.artifacts || 'Nisu detektovani'}</span>
                        </div>
                    </div>
                `;
            }

            // 📊 VISUALIZATIONS CONTENT
            generateVisualizationsContent(data) {
                return `
                    <div class="visualizations-section">
                        <div class="visualization-grid">
                            <div class="viz-card">
                                <h5>1. EKG Signal sa Detektovanim R-pikovima</h5>
                                <p>Originalni EKG signal sa označenim R-pikovima koji su automatski detektovani algoritmom.</p>
                                <button class="btn-viz" onclick="window.ekgAnalyzer.generateThesisVisualization('ekg_with_peaks')">
                                    <i class="fas fa-chart-line"></i> Generiši dijagram
                                </button>
                            </div>
                            
                            <div class="viz-card">
                                <h5>2. FFT Spektar (Furijeova Transformacija)</h5>
                                <p>Frekvencijski spektar EKG signala dobijen Furijeovom transformacijom. Dominantna frekvencija označena crvenom linijom.</p>
                                <button class="btn-viz" onclick="window.ekgAnalyzer.generateThesisVisualization('fft_spectrum')">
                                    <i class="fas fa-wave-square"></i> Generiši FFT spektar
                                </button>
                            </div>
                            
                            <div class="viz-card">
                                <h5>3. Poređenje sa MIT-BIH Anotacijama</h5>
                                <p>Poređenje automatski detektovanih R-pikova (crveno) sa ekspertskim MIT-BIH anotacijama (zeleno).</p>
                                <button class="btn-viz" onclick="window.ekgAnalyzer.generateThesisVisualization('mitbih_comparison')">
                                    <i class="fas fa-balance-scale"></i> Generiši poređenje
                                </button>
                            </div>
                            
                            <div class="viz-card">
                                <h5>4. Signal Processing Pipeline (Z-transformacija)</h5>
                                <p>Koraci obrade signala korišćenjem Z-transformacije: originalni signal, bandpass filtriranje, baseline removal.</p>
                                <button class="btn-viz" onclick="window.ekgAnalyzer.generateThesisVisualization('z_transform_pipeline')">
                                    <i class="fas fa-project-diagram"></i> Generiši pipeline
                                </button>
                            </div>
                            
                            <div class="viz-card">
                                <h5>5. Pole-Zero Analysis & Filter Stability</h5>
                                <p>Analiza polova i nula različitih filtera u Z-ravni sa procenom stabilnosti sistema.</p>
                                <button class="btn-viz" onclick="window.ekgAnalyzer.generateThesisVisualization('pole_zero_analysis')">
                                    <i class="fas fa-crosshairs"></i> Generiši analizu
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 🔧 TOGGLE FUNCTION
            toggleSection(sectionId) {
                const section = document.querySelector(`[data-section="${sectionId}"]`);
                const content = section.querySelector('.accordion-content');
                const icon = section.querySelector('.toggle-icon');
                
                if (this.expandedSections.has(sectionId)) {
                    // Collapse
                    this.expandedSections.delete(sectionId);
                    section.classList.remove('expanded');
                    content.classList.remove('show');
                    icon.classList.remove('rotated');
                } else {
                    // Expand
                    this.expandedSections.add(sectionId);
                    section.classList.add('expanded');
                    content.classList.add('show');
                    icon.classList.add('rotated');
                }
            }

            // 📊 CORRELATION CONTENT
            generateCorrelationContent(data) {
                return `
                    <div class="correlation-section">
                        <div class="section-description">
                            <i class="fas fa-info-circle"></i>
                            <p>Analiza korelacije između različitih parametara EKG signala za naprednu dijagnostiku.</p>
                        </div>
                        
                        <div class="test-grid">
                            <div class="test-card">
                                <h5>Korelacija R-R intervala</h5>
                                <p>Analiza korelacije između uzastopnih R-R intervala za detekciju aritmija.</p>
                                <button class="btn-viz" onclick="window.enableCorrelationTest && window.enableCorrelationTest()">
                                    <i class="fas fa-chart-area"></i> Pokreni test korelacije
                                </button>
                            </div>
                            
                            <div class="test-card">
                                <h5>HRV Korelacijska Analiza</h5>
                                <p>Korelacija između HRV parametara i frekvencijskih komponenti.</p>
                                <button class="btn-viz" onclick="window.accordionDisplay.runHRVCorrelation()">
                                    <i class="fas fa-heartbeat"></i> HRV korelacija
                                </button>
                            </div>
                            
                            <div class="test-card">
                                <h5>Morphology Correlation</h5>
                                <p>Korelacijska analiza morfoloških karakteristika QRS kompleksa.</p>
                                <button class="btn-viz" onclick="window.accordionDisplay.runMorphologyCorrelation()">
                                    <i class="fas fa-wave-square"></i> Morfološka korelacija
                                </button>
                            </div>
                        </div>
                        
                        <div class="correlation-results" id="correlationResults" style="display: none;">
                            <h5>Rezultati korelacijske analize</h5>
                            <div class="correlation-data"></div>
                        </div>
                    </div>
                `;
            }

            // 🖼️ IMAGE PROCESSING CONTENT
            generateImageProcessingContent(data) {
                return `
                    <div class="image-processing-section">
                        <div class="section-description">
                            <i class="fas fa-info-circle"></i>
                            <p>Napredna obrada i analiza EKG slika korišćenjem računarske vizije i filtriranja.</p>
                        </div>
                        
                        <div class="test-grid">
                            <div class="test-card">
                                <h5>Image Enhancement</h5>
                                <p>Poboljšanje kvaliteta EKG slike kroz noise reduction i contrast enhancement.</p>
                                <button class="btn-viz" onclick="window.enableImageProcessingVisualization && window.enableImageProcessingVisualization()">
                                    <i class="fas fa-image"></i> Pokreni Image Processing
                                </button>
                            </div>
                            
                            <div class="test-card">
                                <h5>Edge Detection</h5>
                                <p>Detekcija ivica za preciznije prepoznavanje EKG talasa i kompleksa.</p>
                                <button class="btn-viz" onclick="window.accordionDisplay.runEdgeDetection()">
                                    <i class="fas fa-vector-square"></i> Edge Detection
                                </button>
                            </div>
                            
                            <div class="test-card">
                                <h5>Grid Removal</h5>
                                <p>Automatsko uklanjanje grid linija sa EKG papira za čišći signal.</p>
                                <button class="btn-viz" onclick="window.accordionDisplay.runGridRemoval()">
                                    <i class="fas fa-th"></i> Ukloni Grid
                                </button>
                            </div>
                            
                            <div class="test-card">
                                <h5>Signal Extraction</h5>
                                <p>Ekstrakcija digitalnog signala iz EKG slike korišćenjem naprednih algoritama.</p>
                                <button class="btn-viz" onclick="window.accordionDisplay.runSignalExtraction()">
                                    <i class="fas fa-chart-line"></i> Ekstraktuj Signal
                                </button>
                            </div>
                            
                            <div class="test-card">
                                <h5>Quality Assessment</h5>
                                <p>Automatska procena kvaliteta EKG slike i preporuke za poboljšanje.</p>
                                <button class="btn-viz" onclick="window.accordionDisplay.runQualityAssessment()">
                                    <i class="fas fa-clipboard-check"></i> Proceni Kvalitet
                                </button>
                            </div>
                            
                            <div class="test-card">
                                <h5>Multi-Lead Detection</h5>
                                <p>Automatska detekcija i separacija različitih EKG odvoda na slici.</p>
                                <button class="btn-viz" onclick="window.accordionDisplay.runMultiLeadDetection()">
                                    <i class="fas fa-sitemap"></i> Detektuj Odvode
                                </button>
                            </div>
                        </div>
                        
                        <div class="processing-results" id="processingResults" style="display: none;">
                            <h5>Rezultati image processing analize</h5>
                            <div class="processing-data"></div>
                        </div>
                    </div>
                `;
            }

            // 🔧 HELPER FUNCTIONS for new sections
            runHRVCorrelation() {
                this.showProcessingResult('correlation', 'HRV korelacijska analiza pokrenuta...');
            }

            runMorphologyCorrelation() {
                this.showProcessingResult('correlation', 'Morfološka korelacijska analiza pokrenuta...');
            }

            runEdgeDetection() {
                this.showProcessingResult('image-processing', 'Edge detection algoritam pokrenut...');
            }

            runGridRemoval() {
                this.showProcessingResult('image-processing', 'Grid removal algoritam pokrenut...');
            }

            runSignalExtraction() {
                this.showProcessingResult('image-processing', 'Signal extraction algoritam pokrenut...');
            }

            runQualityAssessment() {
                this.showProcessingResult('image-processing', 'Quality assessment algoritam pokrenut...');
            }

            runMultiLeadDetection() {
                this.showProcessingResult('image-processing', 'Multi-lead detection algoritam pokrenut...');
            }

            showProcessingResult(type, message) {
                const resultsId = type === 'correlation' ? 'correlationResults' : 'processingResults';
                const resultsDiv = document.getElementById(resultsId);
                const dataDiv = resultsDiv.querySelector(type === 'correlation' ? '.correlation-data' : '.processing-data');
                
                if (resultsDiv && dataDiv) {
                    dataDiv.innerHTML = `
                        <div class="processing-message">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>${message}</span>
                        </div>
                    `;
                    resultsDiv.style.display = 'block';
                    
                    // Simulate processing
                    setTimeout(() => {
                        dataDiv.innerHTML = `
                            <div class="success-message">
                                <i class="fas fa-check-circle"></i>
                                <span>Analiza završena uspešno!</span>
                            </div>
                        `;
                    }, 2000);
                }
            }

            // 🔧 EXPAND ALL
            expandAllSections() {
                const sections = document.querySelectorAll('.accordion-section');
                sections.forEach(section => {
                    const sectionId = section.dataset.section;
                    if (!this.expandedSections.has(sectionId)) {
                        this.toggleSection(sectionId);
                    }
                });
            }
        }

        // 🎯 GLOBALNA INSTANCA za pristup iz HTML-a
        window.accordionDisplay = new AccordionResultsDisplay();
        
        // TEST DATA
        const testDataSets = {
            normal: {
                signal_info: {
                    total_samples: 2500,
                    duration: 10.0,
                    sampling_rate: 250,
                    source: 'wfdb_import'
                },
                arrhythmia_detection: {
                    heart_rate: {
                        average_bpm: 75.2,
                        min_bpm: 68.4,
                        max_bpm: 82.1,
                        heart_rate_variability: 45.2,
                        r_peaks_count: 12
                    },
                    arrhythmias: {
                        detected: []
                    },
                    signal_quality: {
                        quality: 'Odličan',
                        snr_db: 24.5
                    }
                },
                r_peak_detection: {
                    r_peaks_count: 12
                },
                fft_analysis: {
                    dominant_frequency: 1.25,
                    peak_amplitude: 0.3245,
                    dc_component: 0.0001
                }
            },
            
            arrhythmia: {
                signal_info: {
                    total_samples: 2500,
                    duration: 10.0,
                    sampling_rate: 250,
                    source: 'wfdb_import'
                },
                arrhythmia_detection: {
                    heart_rate: {
                        average_bpm: 85.6,
                        min_bpm: 62.4,
                        max_bpm: 124.8,
                        heart_rate_variability: 156.3,
                        r_peaks_count: 14
                    },
                    arrhythmias: {
                        detected: [
                            {
                                type: 'Nepravilan ritam',
                                description: 'Visoka varijabilnost RR intervala',
                                value: 'RR std: 0.156s',
                                severity: 'warning'
                            },
                            {
                                type: 'Premature ventricular contractions',
                                description: 'Detektovane ektopične kontrakcije',
                                value: '3 PVC события',
                                severity: 'warning'
                            }
                        ]
                    },
                    signal_quality: {
                        quality: 'Dobar',
                        snr_db: 18.2
                    }
                },
                r_peak_detection: {
                    r_peaks_count: 14
                },
                fft_analysis: {
                    dominant_frequency: 1.42,
                    peak_amplitude: 0.2876,
                    dc_component: 0.0003
                }
            },
            
            tachycardia: {
                signal_info: {
                    total_samples: 2500,
                    duration: 10.0,
                    sampling_rate: 250,
                    source: 'raw_import'
                },
                arrhythmia_detection: {
                    heart_rate: {
                        average_bpm: 150.6,
                        min_bpm: 82.4,
                        max_bpm: 194.8,
                        heart_rate_variability: 143.2,
                        r_peaks_count: 23
                    },
                    arrhythmias: {
                        detected: [
                            {
                                type: 'Tahikardija',
                                description: 'Brz srčani ritam',
                                value: '150.6 bpm',
                                severity: 'critical'
                            },
                            {
                                type: 'Nepravilan ritam',
                                description: 'Visoka varijabilnost RR intervala',
                                value: 'RR std: 0.143s',
                                severity: 'warning'
                            },
                            {
                                type: 'Propušteni otkucaji',
                                description: 'Detektovani neobično dugi RR intervali',
                                value: '4 dugih intervala',
                                severity: 'warning'
                            }
                        ]
                    },
                    signal_quality: {
                        quality: 'Dobar',
                        snr_db: 22.1
                    }
                },
                r_peak_detection: {
                    r_peaks_count: 23
                },
                fft_analysis: {
                    dominant_frequency: 2.80,
                    peak_amplitude: 0.4240,
                    dc_component: 0.0000
                }
            }
        };

        // TEST FUNCTIONS
        function loadTestData(type) {
            const data = testDataSets[type];
            if (!data) {
                console.error('Unknown test data type:', type);
                return;
            }
            
            console.log(`🧪 Loading test data: ${type}`, data);
            
            // Generate accordion interface
            const accordionHTML = window.accordionDisplay.generateAccordionInterface(data);
            
            // Display in test container
            document.getElementById('testResults').innerHTML = accordionHTML;
            
            console.log('✅ Test data loaded successfully');
        }

        function expandAll() {
            if (window.accordionDisplay) {
                window.accordionDisplay.expandAllSections();
                console.log('📋 All sections expanded');
            }
        }

        function collapseAll() {
            const sections = document.querySelectorAll('.accordion-section');
            sections.forEach(section => {
                const sectionId = section.dataset.section;
                if (sectionId !== 'summary' && window.accordionDisplay.expandedSections.has(sectionId)) {
                    window.accordionDisplay.toggleSection(sectionId);
                }
            });
            console.log('📋 All sections collapsed (except summary)');
        }

        // Mock functions for testing
        window.ekgAnalyzer = {
            generatePDF: () => alert('📥 PDF generisanje (test mode)'),
            generateThesisVisualization: (type) => alert(`🎨 Generisanje ${type} vizualizacije (test mode)`),
            showSuccess: (msg) => console.log('✅', msg)
        };

        // Fix onclick handlers for correlation and image processing
        function fixOnclickHandlers() {
            // Fix correlation buttons
            document.querySelectorAll('[onclick*="this.runHRVCorrelation"]').forEach(btn => {
                btn.onclick = () => window.accordionDisplay.runHRVCorrelation();
            });
            document.querySelectorAll('[onclick*="this.runMorphologyCorrelation"]').forEach(btn => {
                btn.onclick = () => window.accordionDisplay.runMorphologyCorrelation();
            });
            
            // Fix image processing buttons
            document.querySelectorAll('[onclick*="this.runEdgeDetection"]').forEach(btn => {
                btn.onclick = () => window.accordionDisplay.runEdgeDetection();
            });
            document.querySelectorAll('[onclick*="this.runGridRemoval"]').forEach(btn => {
                btn.onclick = () => window.accordionDisplay.runGridRemoval();
            });
            document.querySelectorAll('[onclick*="this.runSignalExtraction"]').forEach(btn => {
                btn.onclick = () => window.accordionDisplay.runSignalExtraction();
            });
            document.querySelectorAll('[onclick*="this.runQualityAssessment"]').forEach(btn => {
                btn.onclick = () => window.accordionDisplay.runQualityAssessment();
            });
            document.querySelectorAll('[onclick*="this.runMultiLeadDetection"]').forEach(btn => {
                btn.onclick = () => window.accordionDisplay.runMultiLeadDetection();
            });
        }

        // Auto-load normal data on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                loadTestData('normal');
                setTimeout(fixOnclickHandlers, 100);
            }, 500);
        });
    </script>

</body>
</html>